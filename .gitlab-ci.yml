stages:
  - test
  - build
  - publish
  - deploy-dev
  - deploy-prod

default:
  image: registry.gitlab.com/antoinecampbell/docker-images/build

test:
  stage: test
  script:
    - cd node-functions
    - yarn install
    - yarn test
    - yarn sonar
  cache:
    key: ${CI_JOB_NAME}
    policy: pull-push
    paths:
      - node-functions/node_modules/

build:
  stage: build
  script:
    - cd node-functions
    - yarn build-zip
  artifacts:
    expire_in: 7 days
    paths:
      - node-functions/lambda.zip
  cache:
    key: ${CI_JOB_NAME}
    policy: pull-push
    paths:
      - node-functions/node_modules/

deploy-dev:
  stage: deploy-dev
  environment:
    name: dev
  dependencies:
    - build
  variables:
    TF_ROOT: ${CI_PROJECT_DIR}/terraform
    TF_HTTP_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/dev
    TF_HTTP_USERNAME: gitlab-ci-token
    TF_HTTP_PASSWORD: ${CI_JOB_TOKEN}
    TF_VAR_environment: ${CI_ENVIRONMENT_NAME}
  script:
    - cd terraform
    - terraform init
    - terraform apply -auto-approve
  cache:
    key: ${CI_JOB_NAME}
    policy: pull-push
    paths:
      - ${TF_ROOT}/.terraform